<!--
	============================================================================
	ملف: src/routes/hadith/[id]/+page.svelte
	الوصف: صفحة عرض تفاصيل الحديث الكامل
	============================================================================
	
	هذه الصفحة تعرض تفاصيل حديث واحد بشكل كامل وشامل
	تُستخدم كصفحة تفصيلية عند النقر على أي حديث في التطبيق
	
	المميزات:
	- عرض نص الحديث الكامل بخط عربي أنيق
	- عرض معلومات الراوي وسيرته المختصرة
	- عرض سلسلة الإسناد كاملة
	- عرض درجة الحديث ونوعه
	- أزرار النسخ والمشاركة والحفظ
	- إنشاء صور قابلة للمشاركة
	- التنقل بين الأحاديث (السابق/التالي)
	- عرض أحاديث ذات صلة بنفس الموضوع
	- تصميم متجاوب مع جميع الشاشات
	
	المسار الديناميكي:
	/hadith/[id] حيث id = collection-number
	مثال: /hadith/bukhari-1 (الحديث الأول من صحيح البخاري)
	
	الاعتماديات:
	- lucide-svelte: أيقونات واجهة المستخدم
	- recentlyViewed: مخزن الأحاديث المشاهدة مؤخراً
	- ImageGeneratorModal: نافذة إنشاء الصور
	============================================================================
-->

<script lang="ts">
	// =========================================================================
	// الاستيرادات
	// =========================================================================
	
	// استيراد مخزن الصفحة للوصول لمعاملات URL
	import { page } from '$app/stores';
	
	// دالة دورة الحياة - تُنفذ عند تحميل المكون
	import { onMount } from 'svelte';
	
	// استيراد الأيقونات من مكتبة Lucide
	// BookOpen: أيقونة الكتاب | Star: نجمة التقييم | ChevronRight/Left: أسهم التنقل
	// Copy: نسخ | Share2: مشاركة | Check: علامة صح | Image: صورة
	// Bookmark: حفظ | Heart: إعجاب | MessageCircle: تعليق
	// Volume2: صوت | ExternalLink: رابط خارجي | User: مستخدم
	// Hash: رقم | Layers: طبقات | Calendar: تقويم
	import { 
		BookOpen, Star, ChevronRight, Copy, Share2, Check, 
		Image, Bookmark, BookmarkCheck, Heart, MessageCircle,
		ChevronLeft, Volume2, ExternalLink, User, Hash, Layers, Calendar
	} from 'lucide-svelte';
	
	// مخزن الأحاديث المشاهدة مؤخراً
	import { recentlyViewed } from '$lib/stores/recentlyViewed';
	
	// مكون نافذة إنشاء الصور
	import { ImageGeneratorModal } from '$lib/components/ui';
	
	// =========================================================================
	// متغيرات الحالة (State Variables)
	// =========================================================================
	
	/** 
	 * حالة تحميل المكون
	 * true = تم التحميل (تُفعّل الرسوم المتحركة)
	 */
	let mounted = $state(false);
	
	/**
	 * حالة زر النسخ
	 * true = تم النسخ بنجاح (يظهر علامة صح)
	 */
	let copied = $state(false);
	
	/**
	 * حالة الحفظ في المفضلة
	 * true = محفوظ | false = غير محفوظ
	 */
	let bookmarked = $state(false);
	
	/**
	 * التحكم في ظهور نافذة إنشاء الصور
	 */
	let showImageModal = $state(false);
	
	// =========================================================================
	// المتغيرات المشتقة (Derived Variables)
	// =========================================================================
	
	/**
	 * معرف الحديث من رابط الصفحة
	 * الصيغة: collection-number (مثل: bukhari-1)
	 */
	let hadithId = $derived($page.params.id || 'bukhari-1');
	
	/**
	 * تفكيك معرف الحديث إلى:
	 * - collectionSlug: اسم المجموعة (bukhari, muslim, etc.)
	 * - hadithNum: رقم الحديث
	 */
	let [collectionSlug, hadithNum] = $derived(hadithId.split('-'));
	
	// =========================================================================
	// بيانات المجموعات (كتب الحديث)
	// =========================================================================
	
	/**
	 * قاعدة بيانات كتب الحديث الستة
	 * كل كتاب يحتوي على:
	 * - arabicName: الاسم بالعربية
	 * - arabicAuthor: اسم المؤلف
	 * - grade: درجة الأحاديث (صحيح/حسن)
	 * - color: لون التمييز
	 * - year: سنة وفاة المؤلف
	 */
	const collectionsData: Record<string, any> = {
		// صحيح البخاري - أصح كتاب بعد القرآن
		bukhari: { 
			arabicName: 'صحيح البخاري', 
			arabicAuthor: 'الإمام محمد بن إسماعيل البخاري', 
			grade: 'صحيح',
			color: 'emerald',
			year: '256 هـ'
		},
		// صحيح مسلم - ثاني أصح كتاب
		muslim: { 
			arabicName: 'صحيح مسلم', 
			arabicAuthor: 'الإمام مسلم بن الحجاج النيسابوري', 
			grade: 'صحيح',
			color: 'blue',
			year: '261 هـ'
		},
		// جامع الترمذي
		tirmidhi: { 
			arabicName: 'جامع الترمذي', 
			arabicAuthor: 'الإمام محمد بن عيسى الترمذي', 
			grade: 'حسن',
			color: 'amber',
			year: '279 هـ'
		},
		// سنن أبي داود
		abudawud: { 
			arabicName: 'سنن أبي داود', 
			arabicAuthor: 'الإمام سليمان بن الأشعث السجستاني', 
			grade: 'حسن',
			color: 'purple',
			year: '275 هـ'
		},
		// سنن النسائي
		nasai: { 
			arabicName: 'سنن النسائي', 
			arabicAuthor: 'الإمام أحمد بن شعيب النسائي', 
			grade: 'حسن',
			color: 'rose',
			year: '303 هـ'
		},
		// سنن ابن ماجه
		ibnmajah: { 
			arabicName: 'سنن ابن ماجه', 
			arabicAuthor: 'الإمام محمد بن يزيد ابن ماجه', 
			grade: 'حسن',
			color: 'cyan',
			year: '273 هـ'
		},
	};
	
	// =========================================================================
	// قاعدة بيانات الأحاديث (نموذجية)
	// ملاحظة: في التطبيق الحقيقي، هذه البيانات تأتي من API
	// =========================================================================
	
	const hadithsDatabase: Record<string, any> = {
		// حديث النية - أول حديث في صحيح البخاري
		'bukhari-1': {
			arabicText: 'إِنَّمَا الأَعْمَالُ بِالنِّيَّاتِ، وَإِنَّمَا لِكُلِّ امْرِئٍ مَا نَوَى، فَمَنْ كَانَتْ هِجْرَتُهُ إِلَى دُنْيَا يُصِيبُهَا، أَوْ إِلَى امْرَأَةٍ يَنْكِحُهَا، فَهِجْرَتُهُ إِلَى مَا هَاجَرَ إِلَيْهِ',
			narrator: 'عمر بن الخطاب رضي الله عنه',
			narratorBio: 'أمير المؤمنين، ثاني الخلفاء الراشدين',
			chapter: 'بدء الوحي',
			book: 'كتاب بدء الوحي',
			number: 1,
			topics: ['النية', 'الإخلاص', 'الهجرة'],
			chain: 'حدثنا الحميدي عبد الله بن الزبير قال حدثنا سفيان قال حدثنا يحيى بن سعيد الأنصاري قال أخبرني محمد بن إبراهيم التيمي أنه سمع علقمة بن وقاص الليثي يقول سمعت عمر بن الخطاب رضي الله عنه على المنبر',
			hadithGrade: 'صحيح',
			hadithType: 'مرفوع'
		},
		// حديث أركان الإسلام
		'bukhari-2': {
			arabicText: 'بُنِيَ الإِسْلاَمُ عَلَى خَمْسٍ: شَهَادَةِ أَنْ لاَ إِلَهَ إِلاَّ اللَّهُ وَأَنَّ مُحَمَّدًا رَسُولُ اللَّهِ، وَإِقَامِ الصَّلاَةِ، وَإِيتَاءِ الزَّكَاةِ، وَالْحَجِّ، وَصَوْمِ رَمَضَانَ',
			narrator: 'عبد الله بن عمر رضي الله عنهما',
			narratorBio: 'صحابي جليل، من أكثر الصحابة رواية للحديث',
			chapter: 'الإيمان',
			book: 'كتاب الإيمان',
			number: 8,
			topics: ['أركان الإسلام', 'الإيمان', 'العبادات'],
			chain: 'حدثنا عبيد الله بن موسى قال أخبرنا حنظلة بن أبي سفيان عن عكرمة بن خالد عن ابن عمر رضي الله عنهما',
			hadithGrade: 'صحيح',
			hadithType: 'مرفوع'
		},
		// حديث المسلم من سلم المسلمون
		'bukhari-3': {
			arabicText: 'الْمُسْلِمُ مَنْ سَلِمَ الْمُسْلِمُونَ مِنْ لِسَانِهِ وَيَدِهِ، وَالْمُهَاجِرُ مَنْ هَجَرَ مَا نَهَى اللَّهُ عَنْهُ',
			narrator: 'عبد الله بن عمرو رضي الله عنهما',
			narratorBio: 'صحابي جليل، كان من أكثر الصحابة علماً',
			chapter: 'الإيمان',
			book: 'كتاب الإيمان',
			number: 10,
			topics: ['الأخلاق', 'حقوق المسلم', 'الهجرة'],
			chain: 'حدثنا آدم بن أبي إياس قال حدثنا شعبة عن عبد الله بن أبي السفر وإسماعيل عن الشعبي عن عبد الله بن عمرو رضي الله عنهما',
			hadithGrade: 'صحيح',
			hadithType: 'مرفوع'
		},
		// حديث المحبة للأخ
		'bukhari-4': {
			arabicText: 'لاَ يُؤْمِنُ أَحَدُكُمْ حَتَّى يُحِبَّ لأَخِيهِ مَا يُحِبُّ لِنَفْسِهِ',
			narrator: 'أنس بن مالك رضي الله عنه',
			narratorBio: 'خادم رسول الله ﷺ، من أكثر الصحابة رواية',
			chapter: 'الإيمان',
			book: 'كتاب الإيمان',
			number: 13,
			topics: ['الإيمان', 'الأخوة', 'المحبة'],
			chain: 'حدثنا مسدد قال حدثنا يحيى عن شعبة عن قتادة عن أنس رضي الله عنه',
			hadithGrade: 'صحيح',
			hadithType: 'مرفوع'
		},
		// حديث الكلمة الطيبة وإكرام الجار
		'bukhari-5': {
			arabicText: 'مَنْ كَانَ يُؤْمِنُ بِاللَّهِ وَالْيَوْمِ الآخِرِ فَلْيَقُلْ خَيْرًا أَوْ لِيَصْمُتْ، وَمَنْ كَانَ يُؤْمِنُ بِاللَّهِ وَالْيَوْمِ الآخِرِ فَلْيُكْرِمْ جَارَهُ، وَمَنْ كَانَ يُؤْمِنُ بِاللَّهِ وَالْيَوْمِ الآخِرِ فَلْيُكْرِمْ ضَيْفَهُ',
			narrator: 'أبو هريرة رضي الله عنه',
			narratorBio: 'أكثر الصحابة رواية للحديث النبوي',
			chapter: 'الإيمان',
			book: 'كتاب الإيمان',
			number: 15,
			topics: ['الإيمان', 'الأخلاق', 'حق الجار', 'الضيافة'],
			chain: 'حدثنا أبو اليمان قال أخبرنا شعيب قال حدثنا أبو الزناد عن الأعرج عن أبي هريرة رضي الله عنه',
			hadithGrade: 'صحيح',
			hadithType: 'مرفوع'
		},
		// حديث فضل المساجد - صحيح مسلم
		'muslim-671': {
			arabicText: 'إِنَّ أَحَبَّ بِلَادِ اللَّهِ إِلَى اللَّهِ مَسَاجِدُهَا، وَأَبْغَضَ بِلَادِ اللَّهِ إِلَى اللَّهِ أَسْوَاقُهَا',
			narrator: 'أبو هريرة رضي الله عنه',
			narratorBio: 'أكثر الصحابة رواية للحديث النبوي',
			chapter: 'المساجد',
			book: 'كتاب المساجد ومواضع الصلاة',
			number: 671,
			topics: ['المساجد', 'الأسواق', 'فضل المساجد'],
			chain: 'حدثنا يحيى بن يحيى قال قرأت على مالك عن سمي عن أبي صالح عن أبي هريرة',
			hadithGrade: 'صحيح',
			hadithType: 'مرفوع'
		},
		// نسخة بديلة لحديث المساجد
		'muslim-1': {
			arabicText: 'إِنَّ أَحَبَّ بِلَادِ اللَّهِ إِلَى اللَّهِ مَسَاجِدُهَا، وَأَبْغَضَ بِلَادِ اللَّهِ إِلَى اللَّهِ أَسْوَاقُهَا',
			narrator: 'أبو هريرة رضي الله عنه',
			narratorBio: 'أكثر الصحابة رواية للحديث النبوي',
			chapter: 'المساجد',
			book: 'كتاب المساجد ومواضع الصلاة',
			number: 671,
			topics: ['المساجد', 'الأسواق', 'فضل المساجد'],
			chain: 'حدثنا يحيى بن يحيى قال قرأت على مالك عن سمي عن أبي صالح عن أبي هريرة',
			hadithGrade: 'صحيح',
			hadithType: 'مرفوع'
		}
	};
	
	// =========================================================================
	// المتغيرات المشتقة من البيانات
	// =========================================================================
	
	/**
	 * بيانات المجموعة (الكتاب) الحالية
	 * تُستخرج من collectionSlug أو تُرجع البخاري كافتراضي
	 */
	let collection = $derived(collectionsData[collectionSlug] || collectionsData.bukhari);
	
	/**
	 * بيانات الحديث الحالي
	 * تُستخرج من hadithId أو تُرجع الحديث الأول كافتراضي
	 */
	let hadith = $derived(hadithsDatabase[hadithId] || hadithsDatabase['bukhari-1']);
	
	/**
	 * الأحاديث ذات الصلة
	 * تُفلتر الأحاديث التي تشترك في نفس المواضيع
	 * تُرجع أول 3 أحاديث فقط
	 */
	let relatedHadiths = $derived(
		Object.entries(hadithsDatabase)
			// استبعاد الحديث الحالي
			.filter(([id, h]) => id !== hadithId && h.topics?.some((t: string) => hadith.topics?.includes(t)))
			// أخذ أول 3 نتائج فقط
			.slice(0, 3)
			// تحويل لصيغة مناسبة
			.map(([id, h]) => ({ id, ...h }))
	);

	// =========================================================================
	// معالجات الأحداث (Event Handlers)
	// =========================================================================

	/**
	 * نسخ نص الحديث إلى الحافظة
	 * يُظهر تأكيد بصري لمدة ثانيتين
	 */
	async function copyText(): Promise<void> {
		await navigator.clipboard.writeText(hadith.arabicText);
		copied = true;
		setTimeout(() => copied = false, 2000);
	}
	
	/**
	 * تبديل حالة الحفظ في المفضلة
	 */
	function toggleBookmark(): void {
		bookmarked = !bookmarked;
	}
	
	/**
	 * فتح نافذة إنشاء الصور
	 */
	function openImageGenerator(): void {
		showImageModal = true;
	}
	
	/**
	 * إغلاق نافذة إنشاء الصور
	 */
	function closeImageGenerator(): void {
		showImageModal = false;
	}
	
	// =========================================================================
	// دورة حياة المكون (Lifecycle)
	// =========================================================================
	
	/**
	 * يُنفذ عند تحميل المكون في المتصفح
	 * - يُفعّل الرسوم المتحركة
	 * - يُضيف الحديث لسجل المشاهدة
	 */
	onMount(() => {
		mounted = true;
		
		// إضافة الحديث للأحاديث المشاهدة مؤخراً
		recentlyViewed.add({
			id: hadithId,
			text: hadith.arabicText,
			collection: collection.arabicName,
			narrator: hadith.narrator
		});
	});
</script>
